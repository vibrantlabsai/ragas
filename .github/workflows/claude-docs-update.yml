name: Claude Docs Auto-Update

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      # Trigger when source code changes
      - "src/**/*.py"
      - "ragas/**/*.py"
      # Exclude docs-only changes to prevent infinite loops
      # Claude's commits include [skip ci] by default

jobs:
  claude-docs-update:
    # Skip only if explicitly requested via [skip docs] in PR title
    # The path filter already ensures this only runs for code changes
    if: ${{ !contains(github.event.pull_request.title, '[skip docs]') }}
    
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write  # Required for OIDC token authentication
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 0  # Full history for better context

      - name: Run Claude Docs Update
        uses: anthropics/claude-code-action@beta
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          
          direct_prompt: |
            You are a documentation assistant for the Ragas project. Analyze this PR and determine if documentation updates are needed.

            ## Documentation Structure (Di√°taxis Framework)

            This project follows the Di√°taxis documentation framework with four distinct modes:

            1. **Tutorials** üßë‚Äçüè´ (`docs/getstarted/`, `docs/experimental/tutorials/`)
               - Purpose: Structured learning experience - "Can you teach me to‚Ä¶?"
               - Form: Narrative lesson leading to a working result
               - Include: Context, motivation, complete working examples

            2. **How-to Guides** üç≥ (`docs/howtos/`)
               - Purpose: Help achieve a specific goal - "How do I‚Ä¶?"
               - Form: Concise step-by-step instructions
               - Write from the user's perspective, not the tool's operations
               - Add code outputs as expandable blocks using `??? "Click to expand"`

            3. **Reference** üìë (`docs/references/`)
               - Purpose: Neutral, complete, accurate API description - "What is‚Ä¶?"
               - Maintain consistent patterns (parameter tables, return types, examples)
               - Avoid instruction or opinion; link to how-to or explanation pages

            4. **Explanation** üí° (`docs/concepts/`, `docs/experimental/core_concepts/`)
               - Purpose: Clarify concepts and rationale - "Why‚Ä¶?"
               - Form: Discursive article illuminating design decisions and theory

            ## Your Task

            1. **Analyze the code changes** in this PR to understand what was modified
            2. **Check if documentation updates are needed** for:
               - How-to guides in `docs/howtos/` (if usage patterns changed)
               - Concept docs in `docs/concepts/` (if core concepts were affected)
               - Tutorials in `docs/getstarted/` (if getting started flow changed)

            3. **If documentation updates ARE needed:**
               - Make the necessary updates following the Di√°taxis guidelines above
               - Keep borders sharp: don't mix modes (no instructions in reference, no theory in how-tos)
               - Use second-person ("you") and active voice
               - Ensure code blocks are copy-pasteable with necessary imports
               - Use `??? "Click to expand"` for verbose outputs
               - Add blank line after text ending with colon before lists
               - Update `mkdocs.yml` nav if adding new pages
               - Commit changes with brief message

            4. **If NO documentation updates are needed:**
               - Leave a SHORT (1-2 sentence) PR comment, e.g., "No docs update needed - internal refactoring only"
               - Do NOT include analysis details, checklists, or verbose explanations

            ## IMPORTANT: Do NOT Edit These Files
            - `docs/references/**` - These are AUTO-GENERATED by mkdocstrings from Python docstrings
            - If API documentation needs updating, update the **docstrings in the source code** instead
            - The reference docs will be regenerated automatically during the docs build

            ## Writing Style Guidelines
            - Use second-person ("you") and active voice
            - Prefer short sentences
            - Use Markdown admonitions (`!!! note`, `!!! warning`) sparingly
            - One page = one task, concept, or API surface
            - Cross-link between modes where appropriate

            ## Important
            - Only update docs directly affected by the code changes
            - Keep existing documentation style consistent
            - Don't create new files unless explicitly needed
            - NEVER edit `docs/references/` files (auto-generated from docstrings)
            - For API docs, update the Python docstrings in source code instead
            - Images go in `docs/_static/`
            - Keep PR comments SHORT and concise (no checklists or verbose analysis)

          # Limit execution to prevent runaway costs
          # 25 turns allows for: reading diff, checking multiple doc files, making edits, committing
          max_turns: 25

