name: Claude Docs Check

on:
  pull_request_target:
    types: [opened, synchronize, reopened]
    paths:
      - "src/**/*.py"

jobs:
  check-docs:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 0

      - name: Analyze PR for documentation needs
        id: analyze
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN }}

          prompt: |
            REPO: ${{ github.repository }}
            PR NUMBER: ${{ github.event.pull_request.number }}
            PR TITLE: ${{ github.event.pull_request.title }}

            You are a documentation analyst for the Ragas project. Analyze this PR to determine if documentation updates are needed.

            ## Documentation Structure (DiÃ¡taxis Framework)

            This project follows the DiÃ¡taxis documentation framework:

            1. **Tutorials** (`docs/getstarted/`) - Structured learning experiences
            2. **How-to Guides** (`docs/howtos/`) - Goal-oriented step-by-step instructions
            3. **Reference** (`docs/references/`) - AUTO-GENERATED by mkdocstrings, never edit directly
            4. **Explanation** (`docs/concepts/`) - Conceptual explanations and rationale

            ## Your Task

            1. Review the code changes in this PR using `gh pr diff`
            2. Determine if any documentation updates are needed for:
               - How-to guides in `docs/howtos/` (if usage patterns changed)
               - Concept docs in `docs/concepts/` (if core concepts were affected)
               - Tutorials in `docs/getstarted/` (if getting started flow changed)
               - Python docstrings (if API signatures changed - these feed into auto-generated reference docs)

            3. Return your analysis as structured output with:
               - `needs_update`: boolean - true if docs need updating
               - `reason`: string - brief explanation (1-2 sentences max)

            ## Important Notes
            - `docs/references/` files are AUTO-GENERATED - never suggest editing them directly
            - For API docs, docstring updates in source code are what's needed
            - Internal refactoring with no API/behavior changes = no docs needed
            - Bug fixes with no user-facing changes = no docs needed

            DO NOT make any changes. Only analyze and return structured output.

          claude_args: |
            --max-turns 10
            --json-schema '{"type":"object","properties":{"needs_update":{"type":"boolean"},"reason":{"type":"string"}},"required":["needs_update","reason"]}'
            --allowedTools "Bash(gh pr diff:*),Bash(gh pr view:*),Read,Glob,Grep"

      - name: Parse analysis result
        id: parse
        run: |
          OUTPUT='${{ steps.analyze.outputs.structured_output }}'
          echo "structured_output=$OUTPUT"
          NEEDS_UPDATE=$(echo "$OUTPUT" | jq -r '.needs_update')
          REASON=$(echo "$OUTPUT" | jq -r '.reason')
          echo "needs_update=$NEEDS_UPDATE" >> $GITHUB_OUTPUT
          echo "reason=$REASON" >> $GITHUB_OUTPUT

      - name: Add label and comment if docs needed
        if: steps.parse.outputs.needs_update == 'true'
        run: |
          # Add the needs-doc-update label
          gh pr edit ${{ github.event.pull_request.number }} --add-label "needs-doc-update"

          # Comment with instructions
          gh pr comment ${{ github.event.pull_request.number }} --body "ğŸ“ **Documentation update may be needed**

          ${{ steps.parse.outputs.reason }}

          **To apply documentation updates:** Add the \`update-docs\` label to this PR."
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Comment if no docs needed
        if: steps.parse.outputs.needs_update == 'false'
        run: |
          gh pr comment ${{ github.event.pull_request.number }} --body "âœ… No documentation update needed â€” ${{ steps.parse.outputs.reason }}"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
