name: Claude Docs Apply

on:
  pull_request:
    types: [labeled]

jobs:
  apply-docs:
    if: github.event.label.name == 'update-docs'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          fetch-depth: 0

      - name: Apply documentation updates
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}

          prompt: |
            REPO: ${{ github.repository }}
            PR NUMBER: ${{ github.event.pull_request.number }}
            PR TITLE: ${{ github.event.pull_request.title }}

            You are a documentation assistant for the Ragas project. Update the documentation based on the code changes in this PR.

            ## Documentation Structure (Di√°taxis Framework)

            This project follows the Di√°taxis documentation framework with four distinct modes:

            1. **Tutorials** üßë‚Äçüè´ (`docs/getstarted/`)
               - Purpose: Structured learning experience - "Can you teach me to‚Ä¶?"
               - Form: Narrative lesson leading to a working result
               - Include: Context, motivation, complete working examples

            2. **How-to Guides** üç≥ (`docs/howtos/`)
               - Purpose: Help achieve a specific goal - "How do I‚Ä¶?"
               - Form: Concise step-by-step instructions
               - Write from the user's perspective, not the tool's operations
               - Add code outputs as expandable blocks using `??? "Click to expand"`

            3. **Reference** üìë (`docs/references/`)
               - Purpose: Neutral, complete, accurate API description - "What is‚Ä¶?"
               - ‚ö†Ô∏è AUTO-GENERATED by mkdocstrings - NEVER edit these files directly
               - To update API docs, edit the Python docstrings in source code instead

            4. **Explanation** üí° (`docs/concepts/`)
               - Purpose: Clarify concepts and rationale - "Why‚Ä¶?"
               - Form: Discursive article illuminating design decisions and theory

            ## Your Task

            1. Review the code changes using `gh pr diff`
            2. Make necessary documentation updates:
               - Update how-to guides in `docs/howtos/` if usage patterns changed
               - Update concept docs in `docs/concepts/` if core concepts affected
               - Update tutorials in `docs/getstarted/` if getting started flow changed
               - Update Python docstrings in source code for API documentation

            3. Follow these writing guidelines:
               - Keep borders sharp: don't mix modes (no instructions in reference, no theory in how-tos)
               - Use second-person ("you") and active voice
               - Ensure code blocks are copy-pasteable with necessary imports
               - Use `??? "Click to expand"` for verbose outputs
               - Add blank line after text ending with colon before lists
               - Update `mkdocs.yml` nav if adding new pages

            4. Commit your changes with a clear message

            ## IMPORTANT: Do NOT Edit These Files
            - `docs/references/**` - These are AUTO-GENERATED by mkdocstrings
            - If API documentation needs updating, update the **docstrings in the source code** instead

            ## After Making Changes
            - Commit documentation updates to this PR branch
            - Keep commit messages concise and descriptive

          claude_args: |
            --max-turns 25
            --allowedTools "Read,Write,Edit,Glob,Grep,Bash(git:*),Bash(gh pr diff:*),Bash(gh pr view:*)"

      - name: Remove labels after completion
        if: always()
        run: |
          # Remove both labels
          gh pr edit ${{ github.event.pull_request.number }} --remove-label "update-docs" || true
          gh pr edit ${{ github.event.pull_request.number }} --remove-label "needs-doc-update" || true

          # Comment that docs were updated
          gh pr comment ${{ github.event.pull_request.number }} --body "‚úÖ Documentation update completed."
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
